<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="description" content="Blog with posts about IT"/><meta property="og:image" content="https://og-image.vercel.app/swastek.pl.png?theme=light&amp;md=0&amp;fontSize=75px&amp;images=https%3A%2F%2Fassets.zeit.co%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta name="og:title" content="swastek.pl"/><meta name="twitter:card" content="summary_large_image"/><link rel="preload" as="image" imagesrcset="images/profile.png?imwidth=128 1x, images/profile.png?imwidth=256 2x"/><title>Azure Functions first steps</title><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/0275f6d90e7ad339.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0275f6d90e7ad339.css" data-n-g=""/><link rel="preload" href="/_next/static/css/c39f9723b4064ac0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c39f9723b4064ac0.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-791e43320145be6b.js" defer=""></script><script src="/_next/static/chunks/pages/_app-898c436b230de4c1.js" defer=""></script><script src="/_next/static/chunks/254-0d005fb76719469d.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-2926cdc9a8904f42.js" defer=""></script><script src="/_next/static/APTGIU35JDMBPuWAsT1gi/_buildManifest.js" defer=""></script><script src="/_next/static/APTGIU35JDMBPuWAsT1gi/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="layout_container__fbLkO"><header class="layout_header__kY0Lt"><a href="/"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27108%27%20height=%27108%27/%3e"/></span><img alt="Jakub Swastek" srcSet="images/profile.png?imwidth=128 1x, images/profile.png?imwidth=256 2x" src="images/profile.png?imwidth=256" decoding="async" data-nimg="intrinsic" class="utils_borderCircle__s2nTm" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></span></a><h2 class="utils_headingLg__5535D"><a class="utils_colorInherit__mSH_x" href="/">Jakub Swastek</a></h2></header><main><article><h1 class="utils_headingXl__u25Y2">Azure Functions first steps</h1><div class="utils_lightText__eUzGY"><time dateTime="2022-07-28">July 28, 2022</time></div><div><p>Azure Functions</p>
<p>Kubernetes is one of the most popular platforms for deploying your application, but last year I saw that functions are the next big thing coming. Do you have any part that is not big, maybe not used every day (weekly import) by clients? Does it require a separated container? Maybe this is a good place to start thinking about functions!</p>
<p>The reason, why I'm using weekly import as an example is that it needs to run only for some time in a whole month. Using containers requires DevOps to think about some additional resources behind Kubernetes to be ready for additional traffic. Such containers may need to work also during heavy traffic and use resources that may be planned for other containers. One of the solutions for this case may be using FaaS (function as a service).</p>
<p>Azure Functions allow you to run your code only at a time when it is required and close your application when there is no traffic. It's achieved by a mechanism called triggers. Every function can have only one of it. For example, we have HTTP, Event Hub and Blob triggers. In mentioned case for weekly import, we can use HTTP and Blob triggers.</p>
<p>The flow of our process:</p>
<ul>
<li>customer sends a request with a payload containing import files</li>
<li>the function saves the file in blob storage</li>
<li>once the file is saved in blob storage we have to process it with other functions and save (or log) some result</li>
</ul>
<p>and with Azure functions, we can do it just with a few lines of code!</p>
<p>To work with functions we need <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local?tabs=v4%2Cmacos%2Ccsharp%2Cportal%2Cbash">Azure Functions Core Tools </a> and <a href="https://code.visualstudio.com/">Visual Studio Code</a>. Let's code!</p>
<p>I really recommend installing Azure <a href="https://code.visualstudio.com/docs/azure/extensions">extension</a> for VSC, it provides easy setup for initialization function. Once installed you should have Azure tab in VSC, go there, in workspace section click + and select "Create function". Select Http Trigger, then type name and namespace and pick Anonymous in last select. It will generate code for us.</p>
<p>Next let's generate our blob trigger function. Click + and select "Create function". Select Azure Blob Storage Trigger, then type name and namespace, in last step pick AzureWebJobsStorage and storage name.</p>
<p>Now we have our default functions. Let's replace default code with our triggers</p>
<p>HTTP trigger</p>
<pre><code>using System.IO;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Extensions.Http;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using Azure.Storage.Blobs;

namespace Demo
{
    public static class FileSave
    {
        [FunctionName("FileSave")]
        public static async Task&#x3C;IActionResult> Run(
            [HttpTrigger(AuthorizationLevel.Anonymous, "post", Route = "{name}")] HttpRequest req,
            [Blob("files/{name}", FileAccess.Write ,Connection = "AzureWebJobsStorage")] BlobClient output,
            ILogger log)
        {
            log.LogInformation("C# HTTP trigger function processed a request.");
            await output.UploadAsync(req.Body, true);
            return new OkObjectResult("Done");
        }
    }
}
</code></pre>
<p>Blob trigger (same as generated)</p>
<pre><code>using System.IO;
using Microsoft.Azure.WebJobs;
using Microsoft.Extensions.Logging;

namespace Demo
{
    public static class BlobTrigger
    {
        [FunctionName("BlobTrigger")]
        public static void Run([BlobTrigger("files/{name}", Connection = "AzureWebJobsStorage")]Stream myBlob, string name, ILogger log)
        {
            log.LogInformation($"C# Blob trigger function processed blob\n Name:{name} \n Size: {myBlob.Length} Bytes");
        }
    }
}
</code></pre>
<p>Let's dive into code</p>
<p>This attribute is our function name and will be part of URL.</p>
<pre><code>[FunctionName("FileSave")]
</code></pre>
<p>Our key part is trigger in this case it's HTTP Post request, part of URL should be some name.</p>
<pre><code>[HttpTrigger(AuthorizationLevel.Anonymous, "post", Route = "{name}")] HttpRequest req
</code></pre>
<p>Output of function is blob storage, files will be saved into files container with same name from query. Connection is our connection string from Values section in local.settings.json, replace it with your connection string to local emulator or cloud resource.</p>
<pre><code>[Blob("files/{name}", FileAccess.Write ,Connection = "AzureWebJobsStorage")] BlobClient output
</code></pre>
<p>Saving file to blob storage, second parameter is responsible for overriding existing files with same name.</p>
<pre><code>await output.UploadAsync(req.Body, true);
</code></pre>
<p>Returning some message after upload.</p>
<pre><code>return new OkObjectResult("Done");
</code></pre>
<p>Blob trigger listening for events in our blob at files container.</p>
<pre><code>[BlobTrigger("files/{name}", Connection = "AzureWebJobsStorage")]Stream myBlob
</code></pre>
<p>This parameter value will be same as {name} from trigger.</p>
<pre><code>string name
</code></pre>
<p>Then in console you can type <code>func start</code> to run functions. Result should be same as below.</p>
<pre><code>Functions:

        FileSave: [POST] http://localhost:7071/api/{name}

        BlobTrigger: blobTrigger
</code></pre>
<p>Let's try to post file!</p>
<pre><code>curl http://localhost:7071/api/file.json -d @testFile.json -H "Content-Type: application/javascript"
</code></pre>
<p>In your Storage Explorer you should see new file with name from query!</p>
<p>Resources:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook?tabs=in-process%2Cfunctionsv2&#x26;pivots=programming-language-csharp">HTTP trigger docs</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-blob?tabs=in-process%2Cextensionv5%2Cextensionv3&#x26;pivots=programming-language-csharp">Blob trigger docs</a></li>
</ul>
</div></article></main><div class="layout_backToHome__9sjx_"><a href="/">‚Üê Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"azure-functions-29072022","contentHtml":"\u003cp\u003eAzure Functions\u003c/p\u003e\n\u003cp\u003eKubernetes is one of the most popular platforms for deploying your application, but last year I saw that functions are the next big thing coming. Do you have any part that is not big, maybe not used every day (weekly import) by clients? Does it require a separated container? Maybe this is a good place to start thinking about functions!\u003c/p\u003e\n\u003cp\u003eThe reason, why I'm using weekly import as an example is that it needs to run only for some time in a whole month. Using containers requires DevOps to think about some additional resources behind Kubernetes to be ready for additional traffic. Such containers may need to work also during heavy traffic and use resources that may be planned for other containers. One of the solutions for this case may be using FaaS (function as a service).\u003c/p\u003e\n\u003cp\u003eAzure Functions allow you to run your code only at a time when it is required and close your application when there is no traffic. It's achieved by a mechanism called triggers. Every function can have only one of it. For example, we have HTTP, Event Hub and Blob triggers. In mentioned case for weekly import, we can use HTTP and Blob triggers.\u003c/p\u003e\n\u003cp\u003eThe flow of our process:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ecustomer sends a request with a payload containing import files\u003c/li\u003e\n\u003cli\u003ethe function saves the file in blob storage\u003c/li\u003e\n\u003cli\u003eonce the file is saved in blob storage we have to process it with other functions and save (or log) some result\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eand with Azure functions, we can do it just with a few lines of code!\u003c/p\u003e\n\u003cp\u003eTo work with functions we need \u003ca href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local?tabs=v4%2Cmacos%2Ccsharp%2Cportal%2Cbash\"\u003eAzure Functions Core Tools \u003c/a\u003e and \u003ca href=\"https://code.visualstudio.com/\"\u003eVisual Studio Code\u003c/a\u003e. Let's code!\u003c/p\u003e\n\u003cp\u003eI really recommend installing Azure \u003ca href=\"https://code.visualstudio.com/docs/azure/extensions\"\u003eextension\u003c/a\u003e for VSC, it provides easy setup for initialization function. Once installed you should have Azure tab in VSC, go there, in workspace section click + and select \"Create function\". Select Http Trigger, then type name and namespace and pick Anonymous in last select. It will generate code for us.\u003c/p\u003e\n\u003cp\u003eNext let's generate our blob trigger function. Click + and select \"Create function\". Select Azure Blob Storage Trigger, then type name and namespace, in last step pick AzureWebJobsStorage and storage name.\u003c/p\u003e\n\u003cp\u003eNow we have our default functions. Let's replace default code with our triggers\u003c/p\u003e\n\u003cp\u003eHTTP trigger\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eusing System.IO;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Mvc;\nusing Microsoft.Azure.WebJobs;\nusing Microsoft.Azure.WebJobs.Extensions.Http;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.Extensions.Logging;\nusing Azure.Storage.Blobs;\n\nnamespace Demo\n{\n    public static class FileSave\n    {\n        [FunctionName(\"FileSave\")]\n        public static async Task\u0026#x3C;IActionResult\u003e Run(\n            [HttpTrigger(AuthorizationLevel.Anonymous, \"post\", Route = \"{name}\")] HttpRequest req,\n            [Blob(\"files/{name}\", FileAccess.Write ,Connection = \"AzureWebJobsStorage\")] BlobClient output,\n            ILogger log)\n        {\n            log.LogInformation(\"C# HTTP trigger function processed a request.\");\n            await output.UploadAsync(req.Body, true);\n            return new OkObjectResult(\"Done\");\n        }\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBlob trigger (same as generated)\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eusing System.IO;\nusing Microsoft.Azure.WebJobs;\nusing Microsoft.Extensions.Logging;\n\nnamespace Demo\n{\n    public static class BlobTrigger\n    {\n        [FunctionName(\"BlobTrigger\")]\n        public static void Run([BlobTrigger(\"files/{name}\", Connection = \"AzureWebJobsStorage\")]Stream myBlob, string name, ILogger log)\n        {\n            log.LogInformation($\"C# Blob trigger function processed blob\\n Name:{name} \\n Size: {myBlob.Length} Bytes\");\n        }\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLet's dive into code\u003c/p\u003e\n\u003cp\u003eThis attribute is our function name and will be part of URL.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[FunctionName(\"FileSave\")]\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOur key part is trigger in this case it's HTTP Post request, part of URL should be some name.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[HttpTrigger(AuthorizationLevel.Anonymous, \"post\", Route = \"{name}\")] HttpRequest req\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOutput of function is blob storage, files will be saved into files container with same name from query. Connection is our connection string from Values section in local.settings.json, replace it with your connection string to local emulator or cloud resource.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[Blob(\"files/{name}\", FileAccess.Write ,Connection = \"AzureWebJobsStorage\")] BlobClient output\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSaving file to blob storage, second parameter is responsible for overriding existing files with same name.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eawait output.UploadAsync(req.Body, true);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eReturning some message after upload.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ereturn new OkObjectResult(\"Done\");\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBlob trigger listening for events in our blob at files container.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e[BlobTrigger(\"files/{name}\", Connection = \"AzureWebJobsStorage\")]Stream myBlob\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis parameter value will be same as {name} from trigger.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003estring name\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen in console you can type \u003ccode\u003efunc start\u003c/code\u003e to run functions. Result should be same as below.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eFunctions:\n\n        FileSave: [POST] http://localhost:7071/api/{name}\n\n        BlobTrigger: blobTrigger\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLet's try to post file!\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ecurl http://localhost:7071/api/file.json -d @testFile.json -H \"Content-Type: application/javascript\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn your Storage Explorer you should see new file with name from query!\u003c/p\u003e\n\u003cp\u003eResources:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook?tabs=in-process%2Cfunctionsv2\u0026#x26;pivots=programming-language-csharp\"\u003eHTTP trigger docs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-blob?tabs=in-process%2Cextensionv5%2Cextensionv3\u0026#x26;pivots=programming-language-csharp\"\u003eBlob trigger docs\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","title":"Azure Functions first steps","date":"2022-07-28"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"azure-functions-29072022"},"buildId":"APTGIU35JDMBPuWAsT1gi","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>